var CrDownload,CrLoadingCount,CrChartCount=0;function CrSelectCountry(r){$(".chart-item-data, .chart-item, .chart-item-table").remove(),CrChartCount=0,$("body").append('<div class="page-loading-ajax" style="display: none;"><div class="chart-loading-text"><span class="fa fa-spinner fa-spin"></span><br /><br />Please wait a moment while we create your report</div></div>'),$(".page-loading-ajax").fadeIn(),$.ajax({url:siteData.data("url")+"/report/country/"+r,type:"post",dataType:"json",data:{method:"exists",period:$(".chart-period").data("period"),startTime:$(".chart-time").data("start"),endTime:$(".chart-time").data("end"),reports:$("#FormReportCountry_reports").val()},success:function(r){r.valid?(triggerFileDownload(r.url,r.filename),$(".page-loading-ajax").fadeOut(function(){$(this).remove()})):void 0!==r.error&&CrTriggerCharts()}})}function CrTriggerCharts(){var a={trade:{},macro:{}};$("#FormReportCountry_reports option:selected").each(function(){var r=$(this).data("cat");"trade"==r?a[r][$(this).val()]={indicator:$(this).val()}:"macro"==r&&(a[r][$(this).val()]={macro:$(this).val()})});var t=!0,r=$(".report-data").data("reporter");for(var e in a)for(var o in a[e])CrChartCount++;for(var e in a)for(var o in a[e])a[e][o].period=$(".chart-period").data("period"),a[e][o].startTime=$(".chart-time").data("start"),a[e][o].endTime=$(".chart-time").data("end"),a[e][o].view="data",a[e][o].reporter=r,$.ajax({url:siteData.data("url")+"/"+e+"/chart/",dataType:"json",type:"post",data:a[e][o],success:function(r){r.valid?($(".chart-group[data-chart-type="+r.type+"] .chart-group-data").append(r.chart.data),drawChart(r.chart.chartId),t&&(t=!1,CrDownload="init",CrTriggerDownload())):0==--CrChartCount&&($(".page-loading-ajax").fadeOut(function(){$(this).remove()}),addFlashMessage("danger","Sorry, there isn't enough data for that country"))}})}function CrTriggerDownload(){var r=0,a=["macro","trade"];for(var t in a)void 0!==$(".chart-group[data-chart-type="+a[t]+"] .chart-loading").data("count")&&(r+=parseInt($(".chart-group[data-chart-type="+a[t]+"] .chart-loading").data("count")));if(isNaN(r)||(CrLoadingCount=r),0<CrLoadingCount)"init"==CrDownload&&(CrDownload="loading"),setTimeout(function(){CrTriggerDownload()},200);else if(CrLoadingCount<1&&"loading"==CrDownload)for(var t in CrDownload="render",CrLoadingCount=0,a)$(".chart-group[data-chart-type="+a[t]+"] .chart-item").each(function(){CrLoadingCount++;var r=chartsLog[$(this).data("chart-id")],a=google.visualization.events.addListener(r.chartObjPrint,"ready",function(){CrLoadingCount--,google.visualization.events.removeListener(a),CrTriggerDownload()});renderPrintableChart(r.chartId,"pdfReport")});else CrLoadingCount<1&&"render"==CrDownload&&(CrDownload="done",setTimeout(function(){CrDownloadReport()},200))}function CrDownloadReport(e){e=void 0!==e?e:0;var r=["macro","trade"],t={};for(var a in r)t[r[a]]={},$(".chart-group[data-chart-type="+r[a]+"] .chart-item-data").each(function(r){if(void 0!==$(this).data("img")&&0<$(this).data("img").length){var a=$(this).parents(".chart-group").data("chart-type");switch(a){case"macro":t[a][$(this).data("macro")]=$(this).data();break;case"trade":t[a][$(this).data("indicator")]=$(this).data()}}});$.ajax({url:siteData.data("url")+"/report/country/"+$(".report-data").data("reporter"),type:"post",dataType:"json",contentType:"application/x-www-form-urlencoded",data:{period:$(".chart-period").data("period"),startTime:$(".chart-time").data("start"),endTime:$(".chart-time").data("end"),reports:$("#FormReportCountry_reports").val(),format:$("#FormReportCountry_format").val(),charts:t},success:function(r){var a=!1;if(r.valid)triggerFileDownload(r.url,r.filename),a=!0;else if(r.resend&&e<10)CrDownloadReport(++e);else if(void 0!==r.error){for(var t in r.error)addFlashMessage("danger",r.error[t]);a=!0}a&&$(".page-loading-ajax").fadeOut(function(){$(this).remove()})},error:function(){$(".page-loading-ajax").fadeOut(function(){$(this).remove()})}})}function crRefreshTypeahead(r){r=void 0!==r&&r;var a=[],t=(void 0!==$("#FormReportCountry_reporter").data("ref")&&$("#FormReportCountry_reporter").data("ref"),$("#FormReportCountry_reports").val()),e=$(".chart-period").data("period");a.push({selector:"#FormReportCountry_reporter",url:siteData.data("url")+"/autoComplete/reporterTrade?period="+e+"&term=%QUERY"}),$(".reporter-field-label").html('<span class="fa fa-spinner fa-spin"></span> Recalculating, please wait'),$(".search-list-container .chart-search-list-reporter").slideUp(),$(".search-list-container .form-group").addClass("loading"),filterLists($(".search-list-container .chart-search-list-reporter"),{type:"countryReport",reports:t,period:e,field:"FormReportCountry_reporter",countryReport:a}),r&&refreshTypeahead("countryReport",a,r)}function crValidateSubmitBtn(r){r=void 0===r||r;var a=!0;null===$("#FormReportCountry_reports").val()&&(a=!1),void 0!==$("#FormReportCountry_reporter").data("ref")&&""!=$("#FormReportCountry_reporter").data("ref")?$("#FormReportCountry_reporter").data("ref"):a=!1,a?$(".cr-submit-btn").addClass("btn-primary btn-inverse").removeClass("btn-disabled"):$(".cr-submit-btn").addClass("btn-disabled").removeClass("btn-primary btn-inverse"),r&&crRefreshTypeahead()}$(function(){$(".cr-submit-btn").click(function(r){r.preventDefault(),$(this).hasClass("btn-disabled")||($(".report-data").data("reporter",$("#FormReportCountry_reporter").data("ref")),CrSelectCountry($("#FormReportCountry_reporter").data("ref")))}),crRefreshTypeahead(!0),crValidateSubmitBtn(!1),$("#FormReportCountry_reports").on("changed.bs.select",function(){$("#FormReportCountry_reporter").data("ref","").typeahead("val",""),crValidateSubmitBtn(!0)})});