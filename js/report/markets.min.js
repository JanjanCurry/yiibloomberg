function limitAddAsset(){10<=$(".market-asset-selection .form-group").length?$(".market-asset-add-btns").slideUp():$(".market-asset-add-btns").slideDown()}function marketRefreshTypeahead(t){t=void 0!==t&&t;var e={COM:[],CUR:[],EQU:[]};$(".market-asset-selection input").each(function(){if(void 0!==$(this).data("ref")){var t=$(this).data("ref").slice(0,3),a=$(this).data("ref").slice(4);e[t].push(a)}}),e.COM.join(),e.CUR.join(),e.EQU.join(),t||(filterLists($("#chartMarketModal .chart-search-list-commodity, #chartMarketCompareModal .chart-search-list-commodity"),{type:"commodity",restrict:e.COM,selected:e.COM}),filterLists($("#chartMarketModal .chart-search-list-currency, #chartMarketCompareModal .chart-search-list-currency"),{type:"currency",restrict:e.CUR,selected:e.CUR}),filterLists($("#chartMarketModal .chart-search-list-equity, #chartMarketCompareModal .chart-search-list-equity"),{type:"equity",restrict:e.EQU,selected:e.EQU}));var a=[];a.push({selector:".commodity-search input",url:siteData.data("url")+"/autoComplete/commodity?restrict="+e.COM+"&term=%QUERY"}),a.push({selector:".currency-search input",url:siteData.data("url")+"/autoComplete/currency?restrict="+e.CUR+"&term=%QUERY"}),a.push({selector:".equity-search input",url:siteData.data("url")+"/autoComplete/equity?restrict="+e.EQU+"&term=%QUERY"}),refreshTypeahead("market",a,t)}function marketValidateSubmitBtn(){var t=!0;t&&(t=!1,$("#chartMarketModal .market-search input").each(function(){void 0!==$(this).data("ref")&&""!=$(this).data("ref")&&(t=!0)})),t?$("#chartMarketModal .chart-submit-btn").addClass("btn-primary btn-inverse").removeClass("btn-disabled"):$("#chartMarketModal .chart-submit-btn").addClass("btn-disabled").removeClass("btn-primary btn-inverse"),1<=$(".market-asset-selection .form-group").length?$(".mr-submit-btn").addClass("btn-primary btn-inverse").removeClass("btn-disabled"):$(".mr-submit-btn").addClass("btn-disabled").removeClass("btn-primary btn-inverse")}function MrSelectMarket(){$(".chart-item-data, .chart-item, .chart-item-table").remove(),CrChartCount=0,$("body").append('<div class="page-loading-ajax" style="display: none;"><div class="chart-loading-text"><span class="fa fa-spinner fa-spin"></span><br /><br />Please wait a moment while we generate your real-time report</div></div>'),$(".page-loading-ajax").fadeIn(),MrTriggerCharts()}function MrTriggerCharts(){var i={commodity:{},currency:{},equity:{}};$(".market-asset-selection input").each(function(t){var a=$(this).data("ref"),e=a.substring(0,3),r=a.slice(4);switch(e){case"COM":e="commodity";break;case"CUR":e="currency";break;case"EQU":e="equity"}i[e][r]={item:r}});var a=!0;for(var t in i)for(var e in i[t])CrChartCount++;for(var t in i)for(var e in i[t])i[t][e].view="data",$.ajax({url:siteData.data("url")+"/"+t+"/chart/",dataType:"json",type:"post",data:i[t][e],success:function(t){t.valid?($(".chart-group[data-chart-type="+t.type+"] .chart-group-data").append(t.chart.data),drawChart(t.chart.chartId),a&&(a=!1,CrDownload="init",MrTriggerDownload())):(CrChartCount--,0==CrChartCount&&($(".page-loading-ajax").fadeOut(function(){$(this).remove()}),addFlashMessage("danger","Sorry, there isn't enough data for that asset")))}})}function MrTriggerDownload(){var t=0,a=["commodity","currency","equity"];for(var e in a)void 0!==$(".chart-group[data-chart-type="+a[e]+"] .chart-loading").data("count")&&(t+=parseInt($(".chart-group[data-chart-type="+a[e]+"] .chart-loading").data("count")));if(isNaN(t)||(CrLoadingCount=t),0<CrLoadingCount)"init"==CrDownload&&(CrDownload="loading"),setTimeout(function(){MrTriggerDownload()},200);else if(CrLoadingCount<1&&"loading"==CrDownload)for(var e in CrDownload="render",CrLoadingCount=0,a)$(".chart-group[data-chart-type="+a[e]+"] .chart-item").each(function(){CrLoadingCount++;var t=chartsLog[$(this).data("chart-id")],a=google.visualization.events.addListener(t.chartObjPrint,"ready",function(){CrLoadingCount--,google.visualization.events.removeListener(a),MrTriggerDownload()});renderPrintableChart(t.chartId,"pdfReport")});else CrLoadingCount<1&&"render"==CrDownload&&(CrDownload="done",setTimeout(function(){MrDownloadReport()},200))}function MrDownloadReport(r){r=void 0!==r?r:0;var t=["commodity","currency","equity"],e={};for(var a in t)e[t[a]]={},$(".chart-group[data-chart-type="+t[a]+"] .chart-item-data").each(function(t){if(void 0!==$(this).data("img")&&0<$(this).data("img").length){var a=$(this).parents(".chart-group").data("chart-type");e[a][$(this).data("item")]=$(this).data()}});$.ajax({url:siteData.data("url")+"/report/market/",type:"post",dataType:"json",contentType:"application/x-www-form-urlencoded",data:{format:$("#FormReportMarket_format").val(),charts:e},success:function(t){var a=!1;if(t.valid)triggerFileDownload(t.url,t.filename),a=!0;else if(t.resend&&r<10)MrDownloadReport(++r);else if(void 0!==t.error){for(var e in t.error)addFlashMessage("danger",t.error[e]);a=!0}a&&$(".page-loading-ajax").fadeOut(function(){$(this).remove()})},error:function(){$(".page-loading-ajax").fadeOut(function(){$(this).remove()})}})}$(function(){marketRefreshTypeahead(!0),marketValidateSubmitBtn(),$(".mr-submit-btn").click(function(t){t.preventDefault(),$(this).hasClass("btn-disabled")||MrSelectMarket()}),$(document).on("click",".market-asset-selection .clearBtn",function(){$(this).parents(".form-group").slideUp(function(){$(this).remove(),limitAddAsset(),marketValidateSubmitBtn()})}),$(".market-asset-add-btns .btn").click(function(){var t=$(this).data("market");$("#chartMarketModal .market-search").hide(),$("#chartMarketModal .market-search input").data("ref","").typeahead("val",""),marketRefreshTypeahead(),$("#chartMarketModal ."+t+"-search").show(),$("#chartMarketModal").data("type",t).modal("show")}),$("#chartMarketModal .market-search input").on("typeahead:selected",function(t,a,e){$(this).data("ref",a.code),validateSubmitBtn("market")}).on("keyup",function(t){""==$(this).typeahead("val")?($(this).data("ref",""),validateSubmitBtn("market")):13==t.which&&0<$(this).parents(".form-group").find(".tt-suggestion:first-child").length&&$(this).parents(".form-group").find(".tt-suggestion:first-child").trigger("click")}),$("#chartMarketModal .chart-submit-btn").click(function(){var t=$(this),a=t.parents(".modal").data("type"),e="",r=$("#chartMarketModal ."+a+"-search input").data("ref"),i=$("#chartMarketModal ."+a+"-search input").val();switch(a){case"commodity":i="Commodity: "+i,e="assets_COM-"+r,r="COM-"+r;break;case"currency":i="Currency: "+i,e="assets_CUR-"+r,r="CUR-"+r;break;case"equity":i="Equity: "+i,e="assets_EQU-"+r,r="EQU-"+r}if(!t.hasClass("btn-disabled")){if(t.parents(".modal").modal("hide"),0===$("#"+e).length){var s='<div class="form-group"><div class="input-group"><input type="text" class="form-control" readonly maxlength="255" name="assets['+r+']" data-ref="'+r+'" value="'+i+'" id="'+e+'" /><span class="input-group-btn"><a href="#" class="btn btn-accent clearBtn"><span class="fa fa-times"></span> Remove</a></span></div></div>';$(".market-asset-selection").append(s),marketValidateSubmitBtn()}limitAddAsset()}})});